<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Bailey Andrew">
<meta name="dcterms.date" content="2023-01-12">
<meta name="description" content="Do-do-do-do do-do-do-do">

<title>Lorem Ipsomething - Enter the Simplex</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<link rel="stylesheet" href="../../html_scripts/collapse.css">
<link rel="stylesheet" href="../../html_scripts/pretty_shortcuts.css">
<meta property="og:title" content="Lorem Ipsomething - Enter the Simplex">
<meta property="og:description" content="Do-do-do-do do-do-do-do">
<meta property="og:image" content="https://BaileyAndrew.github.io/Blog/000_Blog/008_simplex/simplex-lines.png">
<meta property="og:site-name" content="Lorem Ipsomething">
<meta property="og:image:height" content="780">
<meta property="og:image:width" content="1342">
<meta name="twitter:title" content="Lorem Ipsomething - Enter the Simplex">
<meta name="twitter:description" content="Do-do-do-do do-do-do-do">
<meta name="twitter:image" content="https://BaileyAndrew.github.io/Blog/000_Blog/008_simplex/simplex-lines.png">
<meta name="twitter:image-height" content="780">
<meta name="twitter:image-width" content="1342">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Lorem Ipsomething</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Enter the Simplex</li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../blog.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Blog</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../staticposts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Static Posts</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Puzzles</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../500_Puzzles/bnv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Boulders in Valleys</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../slideshowindex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Slideshows</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../otherblogs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other People’s Blogs</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#leaving-the-simplex" id="toc-leaving-the-simplex" class="nav-link active" data-scroll-target="#leaving-the-simplex">Leaving the Simplex</a>
  <ul class="collapse">
  <li><a href="#log-ratio-transforms" id="toc-log-ratio-transforms" class="nav-link" data-scroll-target="#log-ratio-transforms"><b style="color:#537FBF">Log-Ratio Transforms</b></a>
  <ul class="collapse">
  <li><a href="#centered-log-ratio-clr" id="toc-centered-log-ratio-clr" class="nav-link" data-scroll-target="#centered-log-ratio-clr"><b style="color:#537FBF">Centered Log-Ratio (CLR)</b></a></li>
  <li><a href="#additive-log-ratio-alr" id="toc-additive-log-ratio-alr" class="nav-link" data-scroll-target="#additive-log-ratio-alr"><b style="color:#537FBF">Additive Log-Ratio (ALR)</b></a></li>
  <li><a href="#isometric-log-ratio-ilr" id="toc-isometric-log-ratio-ilr" class="nav-link" data-scroll-target="#isometric-log-ratio-ilr"><b style="color:#537FBF">Isometric Log-Ratio (ILR)</b></a></li>
  </ul></li>
  <li><a href="#other-transforms" id="toc-other-transforms" class="nav-link" data-scroll-target="#other-transforms">Other Transforms</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/BaileyAndrew/Blog/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Enter the Simplex</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Work</div>
    <div class="quarto-category">Compositional</div>
    <div class="quarto-category">Useful</div>
  </div>
  </div>

<div>
  <div class="description">
    Do-do-do-do do-do-do-do
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Bailey Andrew </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 12, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>“<b style="color:#A6A440">Compositional data</b>” is data representing the <em style="color:#C0CF96">composition</em> of something - i.e.&nbsp;water is 66% H and 33% O (H<sub>2</sub>0) by atom count, so a glass of water could be described as the compositional vector <code>[2/3 1/3]</code> regardless of how big the glass is. It’s <b style="color:#A6A440">scale-independent</b>; <b style="color:#C0CF96">it should always sum to one</b>.</p>
<p>The <b style="color:#A6A440">space</b> that <b style="color:#A6A440">compositional data</b> lives in is called <b style="color:#EB1960">the Simplex</b>. “<b style="color:#EB1960">Simplex</b>” is a fancy name for an arbitrarily-dimensional triangle. Just like how we can imagine the set of vectors with magnitude one as existing on a <b style="color:#EB1960">hypersphere</b> (arbitrarily-dimensional sphere), the set of vectors with sum one exists on a (hyper)triangle with vertices along each of the axes - hence the name “<b style="color:#EB1960">simplex</b>”. This is in contrast with ordinary data, which lives in <b style="color:#EB1960">Euclidean space</b>.</p>
<p><b style="color:#EB1960">Euclidean space</b> is “normal” space; your intuitions about geometric facts are likely to be valid here. However, <b style="color:#EB1960">the Simplex</b> is a different space with different rules. If we do not account for those rules when performing analyses, our results will be erroneous.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./simplex-lines.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">On the left is a straight line in <b style="color:#EB1960">the Simplex</b>. On the right is a straight line in <b style="color:#EB1960">Euclidean space</b>. Note the difference.</figcaption>
</figure>
</div>
<p>If you don’t like the line on the left being “straight”, call it a <b style="color:#A6A440">geodesic</b>; it means the same thing but you probably don’t have any preconceived notions as to its meaning. Note that this is the same reason that long haul planes don’t travel on “straight” lines on the map; the plane is travelling on a straight line (<b style="color:#A6A440">geodesic</b>) in the natural geometry of the earth’s surface (the <b style="color:#A6A440">curvature</b>). A <b style="color:#A6A440">geodesic</b> is the shortest path<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> between two points. <b style="color:#EB1960">The Simplex</b> is graphed as a triangle because of its, well, triangular nature - note that it actually has three axes, one for each side. It may have three parameters, but the <b style="color:#A6A440">dimensionality</b> of the data is 2. In arbitrary dimensions, you may have <span class="math inline">\(n\)</span> numbers, but the last number can always be worked out by 1 minus the sum of the others.</p>
<section id="leaving-the-simplex" class="level1">
<h1>Leaving the Simplex</h1>
<p>One method of dealing with <b style="color:#EB1960">the Simplex</b> is to leave it, by mapping our data onto <b style="color:#EB1960">Euclidean space</b>. The most common way to do this is to use <b style="color:#537FBF">log-ratio transformations</b>. The name <b style="color:#EB1960">Aitchison</b> might pop up if you do some research on this; in fact one name for the geometry of <b style="color:#EB1960">the Simplex</b> is <b style="color:#EB1960">Aitchison Geometry</b>.</p>
<section id="log-ratio-transforms" class="level2">
<h2 class="anchored" data-anchor-id="log-ratio-transforms"><b style="color:#537FBF">Log-Ratio Transforms</b></h2>
<p>Take the set of variables <span class="math inline">\(\{\forall i : x_i\}\)</span> in your <b style="color:#A6A440">compositional data</b>. The set of <b style="color:#A6A440">log-ratios</b> would be <span class="math inline">\(\{\forall i, j : \log \frac{x_i}{x_j}\}\)</span>. Since <b style="color:#A6A440">compositional data</b> is all about relative sizes, it does make intuitive sense why ratios would be important. There are three major <b style="color:#537FBF">log-ratio transforms</b> (<b style="color:#537FBF">CLR</b>, <b style="color:#537FBF">ALR</b>, <b style="color:#537FBF">ILR</b>): they all depend on picking out a particularly nice, small, subset of these <b style="color:#A6A440">log-ratios</b> (or <b style="color:#A6A440">log-ratio</b>-ish things). They’re particularly natural when you have reason to believe your data is close to being <b style="color:#A6A440">log-normally</b> distributed.</p>
<section id="centered-log-ratio-clr" class="level3">
<h3 class="anchored" data-anchor-id="centered-log-ratio-clr"><b style="color:#537FBF">Centered Log-Ratio (CLR)</b></h3>
<p><b style="color:#537FBF">CLR</b> is an <b style="color:#A6A440">isometry</b> - it is a reversible mapping from <b style="color:#EB1960">the Simplex</b> to <b style="color:#EB1960">Euclidean space</b> which perfectly preserves the geometric structure. In other words, it gives us a way of interpreting <b style="color:#EB1960">the Simplex</b> in terms of our pre-existing <b style="color:#EB1960">Euclidean</b> intuitions. While transformations being an <b style="color:#A6A440">isometry</b> does not necessarily make it the right tool for the job, the fact that this is an <b style="color:#A6A440">isometry</b> points to it being a mathematically “natural” thing to do. <i style="color:#C0CF96">Mathematics often rewards naturality</i>.</p>
<p><b style="color:#537FBF">CLR</b> preserves the amount of parameters of the data. The parameters preserve their meaning: the <span class="math inline">\(i\)</span>th parameter pre- and post-<b style="color:#537FBF">CLR</b> still represent a measure of size for the same thingamajig (somewhat like, but different to, measuring things in miles vs kilometers).</p>
<p>Its downside is that it preserves the number of parameters. As we saw, data in <b style="color:#EB1960">the Simplex</b> requires more parameters than its <b style="color:#A6A440">dimensionality</b> - this is still true in the output of <b style="color:#537FBF">CLR</b> as it does not remove parameters.</p>
<p>As an aside, the inverse function of <b style="color:#537FBF">CLR</b> is <b style="color:#537FBF">Softmax</b>.</p>
</section>
<section id="additive-log-ratio-alr" class="level3">
<h3 class="anchored" data-anchor-id="additive-log-ratio-alr"><b style="color:#537FBF">Additive Log-Ratio (ALR)</b></h3>
<p><b style="color:#537FBF">ALR</b> is not an <b style="color:#A6A440">isometry</b>, it is usually close enough to being one <span class="citation" data-cites="quasi-isometry">(<a href="#ref-quasi-isometry" role="doc-biblioref">Greenacre et al. 2022</a>)</span> that the difference does not matter too much. Unlike <b style="color:#537FBF">CLR</b>, <b style="color:#537FBF">ALR</b> reduces the amount of parameters of your data to match its <b style="color:#A6A440">dimensionality</b>. It does this by picking one of your original parameters to be the <b style="color:#A6A440">reference</b>; it will be the denominator in all the <b style="color:#A6A440">log-ratios</b>. Hence the <b style="color:#A6A440">log-ratio</b> associated with the <b style="color:#A6A440">reference</b> will always be 0 and can be ignored. This is, of course, a downside if all of the potential <b style="color:#A6A440">references</b> are interesting in their own right, as one will have to be sacrificed.</p>
<p>This is my personal favorite of the <b style="color:#537FBF">log-ratio transforms</b>; even though I am a mathematician, I think approximate equality is just as good as exact equality in the real world. I don’t need my transform to be an exact <b style="color:#A6A440">isometry</b>.</p>
<details>
<summary>
<b class="sidequests">Sidequest</b><b style="color:#C0CF96">: How to choose a good</b> <b style="color:#A6A440">reference</b> <b style="color:#C0CF96">for</b> <b style="color:#537FBF">ALR</b>
</summary>
<p>I couldn’t find anything online 🤷‍♂️ I assume it’s best to just pick the least interesting parameter. For what I do, there are many uninteresting parameters so this should not be a problem. If we chose a constant parameter <span class="math inline">\(1\)</span>, then I guess this would be equivalent to just taking the log transform.</p>
</details>
</section>
<section id="isometric-log-ratio-ilr" class="level3">
<h3 class="anchored" data-anchor-id="isometric-log-ratio-ilr"><b style="color:#537FBF">Isometric Log-Ratio (ILR)</b></h3>
<p><b style="color:#537FBF">ILR</b> is an <b style="color:#A6A440">isometry</b>, and it also reduces the parameterspace to match the <b style="color:#A6A440">dimensionality</b>. It does this at the cost of interpretability; while there is some kind of interpretation based on the concept of “<b style="color:#A6A440">balances</b>”<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, the parameters post-<b style="color:#537FBF">ILR</b> are not directly related to those pre-<b style="color:#537FBF">ILR</b>. This is my least favorite of the <b style="color:#537FBF">log-ratio transforms</b>; it is mathematically interesting, but at least in the work that I’ve been doing lately I very much want the parameters pre-<b style="color:#537FBF">ILR</b> and post-<b style="color:#537FBF">ILR</b> to have obvious and immediate relationships.</p>
</section>
</section>
<section id="other-transforms" class="level2">
<h2 class="anchored" data-anchor-id="other-transforms">Other Transforms</h2>
<p>There are other transforms, such as Box-Cox (<span class="citation" data-cites="other-transforms">Tsagris, Preston, and Wood (<a href="#ref-other-transforms" role="doc-biblioref">2011</a>)</span>), which are interesting in their own right.</p>
<div class="References">

</div>



</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-quasi-isometry" class="csl-entry" role="listitem">
Greenacre, Michael, Eric Grunsky, John Bacon-Shone, Ionas Erb, and Thomas Quinn. 2022. <span>“Aitchison’s Compositional Data Analysis 40 Years on: A Reappraisal.”</span> arXiv. <a href="https://doi.org/10.48550/ARXIV.2201.05197">https://doi.org/10.48550/ARXIV.2201.05197</a>.
</div>
<div id="ref-other-transforms" class="csl-entry" role="listitem">
Tsagris, Michail T., Simon Preston, and Andrew T. A. Wood. 2011. <span>“A Data-Based Power Transformation for Compositional Data.”</span> <a href="https://doi.org/10.48550/ARXIV.1106.1451">https://doi.org/10.48550/ARXIV.1106.1451</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Well, locally shortest.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Which I must confess I do not really understand.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script>
    // Remove background
    elements = document.querySelectorAll('[id=clean-collapse]').forEach(
        function(element) {
            element.classList.remove("callout-style-default");
        }
    )
    
    // Add arrow to front to signify dropdownyness
    arrow = "▶";
    elements = document.querySelectorAll('.callout-caption-container').forEach(
        function(element) {
            element.innerHTML = arrow + element.innerHTML;
        }
    )
</script>
<script src="https://giscus.app/client.js" data-repo="baileyandrew/blog" data-repo-id="R_kgDOInJwKg" data-category="Announcements" data-category-id="DIC_kwDOInJwKs4CTGOQ" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="dark_protanopia" data-lang="en" data-loading="lazy" crossorigin="anonymous" async="">
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>